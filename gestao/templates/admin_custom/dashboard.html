{% extends "admin_custom/base_admin.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}Dashboard Administrativo{% endblock %}
{% block header_subtitle %}<p class="page-subtitle">Vis√£o consolidada dos clientes, emiss√µes e reservas com hierarquia clara de informa√ß√µes.</p>{% endblock %}
{% block menu_dashboard %}bg-[#2c5282]{% endblock %}
{% block header_actions %}
<div class="page-actions">
  <a id="novoClienteBtn" href="{% url 'admin_novo_cliente' %}" class="btn btn-secondary">+ Novo Cliente</a>
  <a id="novaEmissaoBtn" href="{% url 'admin_nova_emissao' %}{% if selected_cliente %}?cliente_id={{ selected_cliente.id }}{% endif %}" class="btn btn-primary">+ Nova Emiss√£o</a>
</div>
{% endblock %}

{% block content %}
<div class="stacked">
  <section class="surface-card filter-panel" data-filters-root>
    <div class="section-heading">
      <div>
        <p class="eyebrow">Filtro r√°pido</p>
        <p class="section-title">Selecione o cliente para personalizar a vis√£o</p>
      </div>
      <button class="btn btn-ghost filter-toggle" type="button" data-filter-toggle aria-expanded="true">Mostrar filtros</button>
    </div>
    <div class="filter-body is-open" data-filter-panel>
      <div class="form-grid">
        <div class="form-field">
          <label class="form-label" for="clienteSelect">Cliente</label>
          <select id="clienteSelect">
            <option value="">Selecionar Cliente</option>
            {% for c in clientes %}
              <option value="{{ c.id }}" {% if selected_cliente and c.id == selected_cliente.id %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <span class="muted text-sm">Filtre para enxergar cart√µes e relat√≥rios com o contexto correto.</span>
      </div>
    </div>
  </section>

  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Indicadores</p>
        <h2 class="section-title">Resumo r√°pido</h2>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-card">
        <p class="stat-label">üë• Total de Clientes</p>
        <p class="stat-value">{{ total_clientes }}</p>
        <p class="stat-meta">Base ativa de clientes acompanhados</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">‚úàÔ∏è Total de Emiss√µes</p>
        <p class="stat-value">{{ total_emissoes }}</p>
        <p class="stat-meta">Passagens emitidas em todos os programas</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üí∞ Total Economizado</p>
        <p class="stat-value">R$ {{ total_economizado|floatformat:2 }}</p>
        <p class="stat-meta">Economia acumulada em emiss√µes e reservas</p>
      </div>
    </div>
  </section>

  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Programas</p>
        <h2 class="section-title">Pontos, valores e refer√™ncias</h2>
      </div>
    </div>
    <div class="stat-grid">
      {% for prog in programas %}
        <div class="stat-card">
          <p class="stat-label">{{ prog.nome }}</p>
          <p class="stat-value">{{ prog.pontos }}</p>
          <p class="stat-meta">Pontos acumulados</p>
          <div class="section-divider"></div>
          <p class="label">Valor total</p>
          <p class="stat-meta">R$ {{ prog.valor_total|floatformat:2 }}</p>
          <p class="label">Valor m√©dio por 1.000</p>
          <p class="stat-meta">R$ {{ prog.valor_medio|floatformat:2 }}</p>
          <p class="label">Valor de refer√™ncia atual</p>
          <p class="stat-meta">R$ {{ prog.valor_referencia|floatformat:2 }}</p>
          {% if prog.conta_id %}
          <a class="card-link btn btn-link" href="{% url 'admin_movimentacoes' prog.conta_id %}">Ver movimenta√ß√µes</a>
          {% endif %}
        </div>
      {% empty %}
        <p class="muted">Nenhum programa encontrado.</p>
      {% endfor %}
    </div>
  </section>

  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Resumo financeiro</p>
        <h2 class="section-title">Emiss√µes e Hot√©is</h2>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-card">
        <p class="stat-label">Emiss√µes</p>
        <p class="stat-value">{{ emissoes.qtd }}</p>
        <p class="stat-meta">Quantidade total de emiss√µes</p>
        <ul class="list-plain">
          <li>Total de pontos usados: <strong>{{ emissoes.pontos }}</strong></li>
          <li>Valor ref.: <strong>R$ {{ emissoes.valor_referencia|floatformat:2 }}</strong></li>
          <li>Valor pago: <strong>R$ {{ emissoes.valor_pago|floatformat:2 }}</strong></li>
          <li>Economizado: <strong>R$ {{ emissoes.valor_economizado|floatformat:2 }}</strong></li>
        </ul>
        <a class="card-link btn btn-link" href="{% url 'admin_emissoes' %}">Ver detalhes</a>
      </div>

      <div class="stat-card">
        <p class="stat-label">Hot√©is</p>
        <p class="stat-value">{{ hoteis.qtd }}</p>
        <p class="stat-meta">Reservas confirmadas</p>
        <ul class="list-plain">
          <li>Valor ref. acumulado: <strong>R$ {{ hoteis.valor_referencia|floatformat:2 }}</strong></li>
          <li>Valor pago: <strong>R$ {{ hoteis.valor_pago|floatformat:2 }}</strong></li>
          <li>Economizado: <strong>R$ {{ hoteis.valor_economizado|floatformat:2 }}</strong></li>
        </ul>
        <a class="card-link btn btn-link" href="{% url 'admin_hoteis' %}">Ver detalhes</a>
      </div>
    </div>
  </section>

  <section class="surface-card">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Distribui√ß√£o</p>
        <h2 class="section-title">Emiss√µes por programa</h2>
      </div>
    </div>
    <canvas id="emissoesChart"></canvas>
  </section>
</div>
{% endblock %}

{% block extra_body %}
<script>
document.getElementById('clienteSelect').addEventListener('change', function() {
  const value = this.value;
  const url = '{% url "admin_dashboard" %}';
  window.location = value ? url + '?cliente_id=' + value : url;
});

const ctx = document.getElementById('emissoesChart');
if (ctx) {
  const labels = [{% for item in emissoes_programa %}'{{ item.programa }}'{% if not forloop.last %},{% endif %}{% endfor %}];
  const dataVals = [{% for item in emissoes_programa %}{{ item.quantidade }}{% if not forloop.last %},{% endif %}{% endfor %}];

  new Chart(ctx, {
    type: 'bar',
    data: { 
      labels, 
      datasets: [{ 
        label: 'Emiss√µes', 
        data: dataVals, 
        backgroundColor: '#3182ce' 
      }] 
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}
</script>
{% endblock %}
