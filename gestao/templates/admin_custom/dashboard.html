{% extends "admin_custom/base_admin.html" %}
{% load static %}

{% block title %}Dashboard{% endblock %}
{% block header_title %}Dashboard Administrativo{% endblock %}
{% block header_subtitle %}<p class="page-subtitle">Vis√£o consolidada dos clientes, emiss√µes e reservas com hierarquia clara de informa√ß√µes.</p>{% endblock %}
{% block menu_dashboard %}is-active{% endblock %}
{% block header_actions %}
<a id="novoClienteBtn" href="{% url 'admin_novo_cliente' %}" class="btn btn--outline">+ Novo Cliente</a>
<a id="novaEmissaoBtn" href="{% url 'admin_nova_emissao' %}{% if selected_cliente %}?cliente_id={{ selected_cliente.id }}{% endif %}" class="btn">+ Nova Emiss√£o</a>
{% endblock %}

{% block content %}
<div class="stacked">
  <section class="surface-card filter-panel" data-filters-root>
    <div class="section-heading">
      <div>
        <p class="eyebrow">Filtro principal</p>
        <p class="section-title">Escolha o tipo de vis√£o para ajustar os indicadores</p>
      </div>
      <button class="btn btn--ghost filter-toggle" type="button" data-filter-toggle aria-expanded="true">Mostrar filtros</button>
    </div>
    <div class="filter-body is-open" data-filter-panel>
      <div class="form-grid">
        <div class="form-field">
          <label class="form-label" for="viewSelect">Tipo de vis√£o</label>
          <select id="viewSelect">
            <option value="clientes" {% if view_type == "clientes" %}selected{% endif %}>Clientes</option>
            <option value="contas" {% if view_type == "contas" %}selected{% endif %}>Contas administradas</option>
            <option value="parceiros" {% if view_type == "parceiros" %}selected{% endif %}>Emissores parceiros</option>
          </select>
        </div>
        <div class="form-field" data-filter-type="clientes">
          <label class="form-label" for="clienteSelect">Cliente</label>
          <select id="clienteSelect">
            <option value="">Selecionar Cliente</option>
            {% for c in clientes %}
              <option value="{{ c.id }}" {% if selected_cliente and c.id == selected_cliente.id %}selected{% endif %}>{{ c }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field" data-filter-type="contas">
          <label class="form-label" for="contaSelect">Conta administrada</label>
          <select id="contaSelect">
            <option value="">Selecionar Conta</option>
            {% for conta in contas_administradas %}
              <option value="{{ conta.id }}" {% if selected_conta and conta.id == selected_conta.id %}selected{% endif %}>{{ conta.nome }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field" data-filter-type="parceiros">
          <label class="form-label" for="emissorSelect">Emissor parceiro</label>
          <select id="emissorSelect">
            <option value="">Selecionar Emissor</option>
            {% for emissor in emissores_parceiros %}
              <option value="{{ emissor.id }}" {% if selected_emissor and emissor.id == selected_emissor.id %}selected{% endif %}>{{ emissor.nome }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
      <div class="filter-actions">
        <span class="muted text-sm">Filtre para enxergar cart√µes e relat√≥rios com o contexto correto.</span>
      </div>
    </div>
  </section>

  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Indicadores</p>
        <h2 class="section-title">Resumo r√°pido</h2>
      </div>
    </div>
    {% if view_type == "parceiros" %}
    <div class="stat-grid">
      <div class="stat-card">
        <p class="stat-label">‚úàÔ∏è Total de Emiss√µes</p>
        <p class="stat-value">{{ total_emissoes }}</p>
        <p class="stat-meta">Emiss√µes vinculadas ao emissor selecionado</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üßæ Total de milhas emitidas</p>
        <p class="stat-value">{{ parceiros.milhas }}</p>
        <p class="stat-meta">Milhas usadas nas emiss√µes do parceiro</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üí∏ Valor pago ao parceiro</p>
        <p class="stat-value">R$ {{ parceiros.valor_pago|floatformat:2 }}</p>
        <p class="stat-meta">Somat√≥rio de milhas √ó valor do milheiro</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üí∞ Lucro total</p>
        <p class="stat-value">R$ {{ parceiros.lucro|floatformat:2 }}</p>
        <p class="stat-meta">Lucro consolidado das emiss√µes</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üìà Valor m√©dio do milheiro</p>
        <p class="stat-value">R$ {{ parceiros.valor_medio_milheiro|floatformat:2 }}</p>
        <p class="stat-meta">M√©dia ponderada por milhas emitidas</p>
      </div>
    </div>
    {% else %}
    <div class="stat-grid">
      <div class="stat-card">
        <p class="stat-label">
          {% if view_type == "contas" %}üè¢ Total de Contas{% else %}üë• Total de Clientes{% endif %}
        </p>
        <p class="stat-value">{{ total_titulares }}</p>
        <p class="stat-meta">
          {% if view_type == "contas" %}Contas administradas ativas{% else %}Base ativa de clientes acompanhados{% endif %}
        </p>
      </div>
      <div class="stat-card">
        <p class="stat-label">‚úàÔ∏è Total de Emiss√µes</p>
        <p class="stat-value">{{ total_emissoes }}</p>
        <p class="stat-meta">Passagens emitidas em todos os programas</p>
      </div>
      <div class="stat-card">
        <p class="stat-label">üí∞ Total Economizado</p>
        <p class="stat-value">R$ {{ total_economizado|floatformat:2 }}</p>
        <p class="stat-meta">Economia acumulada em emiss√µes e reservas</p>
      </div>
    </div>
    {% endif %}
  </section>

  {% if view_type != "parceiros" %}
  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Programas</p>
        <h2 class="section-title">Pontos, valores e refer√™ncias</h2>
      </div>
    </div>
    <div class="stat-grid">
      {% for prog in programas %}
        <div class="stat-card">
          <p class="stat-label">{{ prog.nome }}</p>
          <p class="stat-value">{{ prog.pontos }}</p>
          <p class="stat-meta">Pontos acumulados</p>
          <div class="section-divider"></div>
          <p class="label">Valor total</p>
          <p class="stat-meta">R$ {{ prog.valor_total|floatformat:2 }}</p>
          <p class="label">Valor m√©dio por 1.000</p>
          <p class="stat-meta">R$ {{ prog.valor_medio|floatformat:2 }}</p>
          <p class="label">Valor de refer√™ncia atual</p>
          <p class="stat-meta">R$ {{ prog.valor_referencia|floatformat:2 }}</p>
          {% if prog.conta_id %}
          <a class="card-link btn btn--ghost" href="{% url 'admin_movimentacoes' prog.conta_id %}">Ver movimenta√ß√µes</a>
          {% endif %}
        </div>
      {% empty %}
        <p class="muted">Nenhum programa encontrado.</p>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <section class="surface-card stacked">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Resumo financeiro</p>
        <h2 class="section-title">{% if view_type == "parceiros" %}Emiss√µes e vendas{% else %}Emiss√µes e Hot√©is{% endif %}</h2>
      </div>
    </div>
    <div class="stat-grid">
      <div class="stat-card">
        <p class="stat-label">Emiss√µes</p>
        <p class="stat-value">{{ emissoes.qtd }}</p>
        <p class="stat-meta">Quantidade total de emiss√µes</p>
        <ul class="list-plain">
          {% if view_type == "parceiros" %}
            <li>Total de milhas emitidas: <strong>{{ parceiros.milhas }}</strong></li>
            <li>Valor pago ao parceiro: <strong>R$ {{ parceiros.valor_pago|floatformat:2 }}</strong></li>
            <li>Valor m√©dio do milheiro: <strong>R$ {{ parceiros.valor_medio_milheiro|floatformat:2 }}</strong></li>
            <li>Lucro: <strong>R$ {{ parceiros.lucro|floatformat:2 }}</strong></li>
          {% else %}
            <li>Total de pontos usados: <strong>{{ emissoes.pontos }}</strong></li>
            <li>Valor ref.: <strong>R$ {{ emissoes.valor_referencia|floatformat:2 }}</strong></li>
            <li>Taxas*: <strong>R$ {{ emissoes.valor_taxas|floatformat:2 }}</strong></li>
            <li>Custo total: <strong>R$ {{ emissoes.custo_total|floatformat:2 }}</strong></li>
            <li>Economizado: <strong>R$ {{ emissoes.valor_economizado|floatformat:2 }}</strong></li>
          {% endif %}
        </ul>
        {% if view_type != "parceiros" %}
        <p class="helper-text mt-3">*Taxas de embarque/companhia a√©rea.</p>
        {% endif %}
        <a class="card-link btn btn--ghost" href="{% url 'admin_emissoes' %}">Ver detalhes</a>
      </div>
      {% if view_type != "parceiros" %}
      <div class="stat-card">
        <p class="stat-label">Hot√©is</p>
        <p class="stat-value">{{ hoteis.qtd }}</p>
        <p class="stat-meta">Reservas confirmadas</p>
        <ul class="list-plain">
          <li>Valor ref. acumulado: <strong>R$ {{ hoteis.valor_referencia|floatformat:2 }}</strong></li>
          <li>Valor pago: <strong>R$ {{ hoteis.valor_pago|floatformat:2 }}</strong></li>
          <li>Economizado: <strong>R$ {{ hoteis.valor_economizado|floatformat:2 }}</strong></li>
        </ul>
        <a class="card-link btn btn--ghost" href="{% url 'admin_hoteis' %}">Ver detalhes</a>
      </div>
      {% endif %}
    </div>
  </section>

  <section class="surface-card">
    <div class="section-heading">
      <div>
        <p class="eyebrow">Distribui√ß√£o</p>
        <h2 class="section-title">Emiss√µes por programa</h2>
      </div>
    </div>
    <canvas id="emissoesChart"></canvas>
  </section>
</div>
{% endblock %}

{% block extra_body %}
<script>
const viewSelect = document.getElementById('viewSelect');
const clienteSelect = document.getElementById('clienteSelect');
const contaSelect = document.getElementById('contaSelect');
const emissorSelect = document.getElementById('emissorSelect');

function buildDashboardUrl() {
  const base = '{% url "admin_dashboard" %}';
  const view = viewSelect ? viewSelect.value : 'clientes';
  const params = new URLSearchParams({ view });
  if (view === 'clientes' && clienteSelect && clienteSelect.value) {
    params.set('cliente_id', clienteSelect.value);
  }
  if (view === 'contas' && contaSelect && contaSelect.value) {
    params.set('conta_id', contaSelect.value);
  }
  if (view === 'parceiros' && emissorSelect && emissorSelect.value) {
    params.set('emissor_id', emissorSelect.value);
  }
  return `${base}?${params.toString()}`;
}

function toggleFilters() {
  const view = viewSelect ? viewSelect.value : 'clientes';
  document.querySelectorAll('[data-filter-type]').forEach((el) => {
    el.style.display = el.dataset.filterType === view ? 'block' : 'none';
  });
}

if (viewSelect) {
  viewSelect.addEventListener('change', () => {
    toggleFilters();
    window.location = buildDashboardUrl();
  });
}
if (clienteSelect) {
  clienteSelect.addEventListener('change', () => {
    window.location = buildDashboardUrl();
  });
}
if (contaSelect) {
  contaSelect.addEventListener('change', () => {
    window.location = buildDashboardUrl();
  });
}
if (emissorSelect) {
  emissorSelect.addEventListener('change', () => {
    window.location = buildDashboardUrl();
  });
}
toggleFilters();

const ctx = document.getElementById('emissoesChart');
if (ctx) {
  const labels = [{% for item in emissoes_programa %}'{{ item.programa }}'{% if not forloop.last %},{% endif %}{% endfor %}];
  const dataVals = [{% for item in emissoes_programa %}{{ item.quantidade }}{% if not forloop.last %},{% endif %}{% endfor %}];

  new Chart(ctx, {
    type: 'bar',
    data: { 
      labels, 
      datasets: [{ 
        label: 'Emiss√µes', 
        data: dataVals, 
        backgroundColor: '#3182ce' 
      }] 
    },
    options: { scales: { y: { beginAtZero: true } } }
  });
}
</script>
{% endblock %}
